import tkinter as tk
from tkinter import filedialog
import joblib
import pefile
import os

# Charger le modèle formé à partir du fichier
model = joblib.load('malware-detection.pkl')

print("le modele est", model)
print(type(model))


def extraire_sequences_appels_api(filepath):
    sequences_api = []
    
    try:
        pe = pefile.PE(filepath)  # Ouvrir le fichier exécutable avec pefile
        # Accès aux sections pertinentes ou trouver les points d'entrée des séquences d'appels API
        for entry in pe.DIRECTORY_ENTRY_IMPORT:
            for API in entry.imports:
                sequences_api.append(API.name)
        # Extraire les séquences d'appels API et les stocker dans sequences_api
        
    except pefile.PEFormatError:
        # Gérer les erreurs lors du traitement du fichier exécutable
        print("Erreur de format de fichier exécutable")
    
    return sequences_api

# Fonction pour soumettre le fichier exécutable et effectuer la prédiction
def soumettre_fichier():
    # Ouvrir une boîte de dialogue pour sélectionner le fichier exécutable
    filepath = filedialog.askopenfilename()
    
    # Prétraitement des données (assurez-vous de suivre le même prétraitement que lors de l'entraînement)
    sequences_api = extraire_sequences_appels_api(filepath)  # Extraction des séquences d'appels API
    donnees_d_entree = [sequences_api]  # Créer une liste de séquences d'appels API
    
    # Préparez les données d'entrée que vous souhaitez soumettre au modèle pour la détection
    
    # Utiliser le modèle pour la prédiction
    prediction = model.predict(donnees_d_entree)
    
    # Afficher les résultats de la prédiction sur l'interface utilisateur
    if prediction == 'malware':
        result_label.config(text="Le fichier est détecté comme un malware.")
    else:
        result_label.config(text="Le fichier est détecté comme bon.")
        
# Créer l'interface utilisateur
root = tk.Tk()

# Bouton pour soumettre le fichier exécutable
submit_button = tk.Button(root, text="Soumettre un fichier", command=soumettre_fichier)
submit_button.pack()



# Étiquette pour afficher les résultats
result_label = tk.Label(root, text="")
result_label.pack()

# Lancer la boucle principale de l'interface utilisateur
root.mainloop()
